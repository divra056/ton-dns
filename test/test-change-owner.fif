"Asm.fif" include
"TonUtil.fif" include

{ 0 -rot runvm } : runvm!

"test-manual-dns.fif" include <s =: code

"test/out/id1.pk" load-keypair =: privkey1 =: pubkey1
"test/out/id2.pk" load-keypair =: privkey2 =: pubkey2 cr

<b
    pubkey1 B,
    <b b> ref,
b> =: storage

<b
    1 8 u,
    pubkey2 B,
b> =: message
message hashB privkey1 ed25519_sign =: signature

<b
    signature B,
    message <s s,
b> <s =: in_msg

."Message #1: pubkey2" cr
."Signature: " cr signature Bx. cr
."Content: "   cr message <s csr.
."Result: "    cr in_msg csr. cr

."Original storage: " cr storage <s csr. cr

."Checking signature localy: " message hashB signature pubkey1 ed25519_chksign x. cr cr

in_msg code storage runvm! =: storage =: exit_code cr
."Result #1: " cr
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr


in_msg code storage runvm! =: storage =: exit_code cr
."Result #2: expect failure - pubkey no longer matches" cr
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr

<b
    1 8 u,
    pubkey1 B,
b> =: message2
message2 hashu privkey2 ed25519_sign_uint =: signature2
<b
    signature2 B,
    message2 <s s,
b> <s =: in_msg2

."Message #2: pubkey1" cr
."Signature: " cr signature Bx. cr
."Content: "   cr message <s csr.
."Result: "    cr in_msg csr. cr

in_msg2 code storage runvm! =: storage =: exit_code cr
."Result #3: change back to original state" cr
."Exit code " exit_code . cr
."Updated storage: " cr storage <s csr. cr
